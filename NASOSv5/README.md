## 在NASOSv5(Not Another SMA Offset Strategy)策略中修改，使其每笔劲量保持在3%盈利

### 1. **整体框架**

- 该策略基于 `Freqtrade` 的 `IStrategy` 接口，继承了其方法和属性。
- 策略的实现包括买入逻辑、卖出逻辑、指标计算、保护机制等。

* * *

### 2. **买入逻辑（`populate_buy_trend` 方法）**

策略的买入逻辑主要由几个条件构成：

- **核心条件：**
    
    - **RSI 相关条件**：
        - 快速 RSI (`rsi_fast`) 和标准 RSI (`rsi`) 的值需满足一定的范围（如 RSI 低于某个阈值）。
    - **价格相对均线的偏移：**
        - 当前价格需要低于特定均线（如 `ma_buy`）乘以一个偏移量 (`low_offset` 或 `low_offset_2`)。
    - **EWO 指标：**
        - EWO（Elliot Wave Oscillator）需满足一定的范围（如高于某个阈值 `ewo_high`）。
    - **成交量和利润条件：**
        - 成交量必须大于 0。
        - 价格在一定的回溯周期内需满足利润阈值（`profit_threshold`）。
- **限制买入的条件：**
    
    - 当价格在回溯周期内无法提供至少 3% 的利润时，不会买入。
    - 其他防止追涨杀跌的条件，比如避免在“泵涨”（`recentispumping`）的情况下买入。
- **买入标记：**
    
    - 如果满足买入条件，会给数据帧的 `buy` 列赋值为 1，并标记为 `buy_tag`。

* * *

### 3. **卖出逻辑（`populate_sell_trend` 方法）**

卖出逻辑则定义了该策略在什么情况下应该卖出：

- **核心条件：**
    
    - 当前价格高于短期均线（如 `sma_9`）。
    - 当前价格高于卖出均线（`ma_sell`）乘以偏移量 (`high_offset` 或 `high_offset_2`)。
    - RSI 快速值高于慢速 RSI 值。
    - 成交量大于 0。
- **灵活性：**
    
    - 使用一个条件列表（`conditions`）来定义多种可能的卖出场景，满足任意一种即可触发卖出信号。

* * *

### 4. **指标计算（`populate_indicators` 方法）**

- 在 `populate_indicators` 方法中，计算了策略所需的技术指标。
- **主要技术指标：**
    - **均线（EMA 和 SMA）：**
        - 多种周期的 `EMA`（指数移动平均）和 `SMA`（简单移动平均）。
    - **EWO 指标：**
        - 自定义的 `EWO` 指标，用于衡量价格变化趋势。
    - **RSI 指标：**
        - 不同周期的 RSI（相对强弱指标）。
    - **反泵检测（Anti-Pump）：**
        - 检测短时间内价格的剧烈波动，并标记是否存在“泵涨”行为。

* * *

### 5. **保护机制（`protections`）**

- 定义了一些保护性机制，限制在特定情况下进行交易：
    - **低利润保护（LowProfitPairs）：**
        - 如果一对交易对在一定时间内的利润低于 -0.05，则暂停交易。
    - **最大回撤保护（MaxDrawdown）：**
        - 如果某个交易对在特定时间内的回撤超过 20%，则暂停交易。

* * *

### 6. **止损逻辑（`custom_stoploss` 方法）**

- 自定义止损逻辑可以动态调整止损水平：
    - 当利润达到特定阈值时，设置更紧的止损以锁定收益。
    - 在不同的利润区间，止损点会线性插值计算。

* * *

### 7. **时间框架和多时间框架支持**

- **主要时间框架：** 5 分钟（`timeframe = '5m'`）。
- **辅助时间框架：** 15 分钟和 1 小时数据，用于计算更广泛的市场趋势。

* * *

### 8. **策略的多样性**

文件中还定义了多个基于原始策略的变体（如 `NASOSv5HO`, `NASOSv5PD`, `NASOSv5SL`, `TrailingBuyStrat`），每个变体可能调整了具体的参数或逻辑以适应不同的市场条件或优化需求。

* * *

### 9. **优化参数**

- 通过 `DecimalParameter` 和 `IntParameter` 等，策略的买卖参数可以被优化（例如通过超参数优化工具 `Hyperopt`）。
- 优化参数包括均线周期、RSI 阈值、偏移量、利润阈值等。

* * *

### 策略的核心理念：

- **趋势跟踪：** 利用均线和 EWO 指标，识别价格的上涨和下跌趋势。
- **反转买入：** 在价格回调时寻找买入机会。
- **保护机制：** 避免在市场剧烈波动或亏损过多的情况下交易。
- **动态调整：** 使用自定义止损和多时间框架支持，适应不同的市场环境。

* * *

在给定的代码中，`NASOSv5HO`、`NASOSv5PD`、`NASOSv5SL` 和 `TrailingBuyStrat` 是 `NASOSv5_mod3` 策略类的不同子类。它们通过重写或扩展父类的属性和方法，形成了不同的交易逻辑。以下是对每个子类策略逻辑的详细分析：

* * *

### 1. **`NASOSv5HO`** (Hyperopt Variant)

- **目的**:
    
    - 这个子类主要调整了 `NASOSv5_mod3` 的买入和卖出参数，用于通过超参数优化（Hyperopt）寻找最优参数。
- **买入参数变化**：
    
    - **`base_nb_candles_buy`**：设置为 8，表示买入信号基于更短期的均线。
    - **`ewo_high` 和 `ewo_high_2`**：EWO 高位阈值调整，分别为 4.13 和 4.477。
    - **`ewo_low`**：调整为 -19.076，意味着更宽的 EWO 范围。
    - **`lookback_candles`**：调整为 27，表示回溯的蜡烛数增加。
    - **`profit_threshold`**：设置为 1.049，表示更高的利润门槛。
    - **`rsi_buy` 和 `rsi_fast_buy`**：分别调整为 72 和 40，表示 RSI 买入条件更严格。
- **卖出参数变化**：
    
    - **`high_offset` 和 `high_offset_2`**：分别调整为 1.012 和 1.431。
    - **`base_nb_candles_sell`**：设置为 8，更短期的卖出均线。
- **止损和 ROI**：
    
    - **止损**：调整为 -0.1（比父类更紧）。
    - **最小 ROI**：设为 0.1。

* * *

### 2. **`NASOSv5PD`** (Pump Detection Variant)

- **目的**:
    
    - 在父类的基础上增加了“泵涨检测”逻辑，防止在市场剧烈波动（泵涨）时买入。
- **主要逻辑变化**：
    
    - 增加了限制条件 `dont_buy_conditions`：
        1.  如果 `recentispumping` 标志为 `True`，则停止买入。
        2.  如果价格在回溯周期内无法达到利润门槛（`profit_threshold`），则停止买入。
- **买入逻辑**：
    
    - 仍然遵循父类的 EWO、RSI 和价格偏移逻辑，只是在上述增加的限制条件下可能会跳过买入信号。

* * *

### 3. **`NASOSv5SL`** (Custom Stoploss Variant)

- **目的**:
    
    - 通过自定义止损逻辑实现更灵活的止损设置，允许策略在小幅获利时更快止盈，同时在更大获利时让利润“奔跑”。
- **卖出参数变化**：
    
    - 增加了以下动态止损参数：
        - **`pHSL`**：硬止损点，默认值为 -0.08。
        - **`pPF_1` 和 `pPF_2`**：利润阈值，分别为 0.016 和 0.08。
        - **`pSL_1` 和 `pSL_2`**：利润阈值对应的止损线，分别为 0.011 和 0.04。
- **自定义止损逻辑（`custom_stoploss` 方法）**：
    
    - 如果当前利润大于 `pPF_1` 和 `pPF_2`，止损线会根据利润水平线性插值计算。
    - 如果当前利润高于 `pPF_2`，则止损线随着利润增加而提高。
    - 如果利润低于 `pPF_1`，则使用硬止损点 `pHSL`。
- **主要卖出逻辑**：
    
    - 更加注重在特定利润区间内动态调整止损，减少不必要的止损。

* * *

### 4. **`TrailingBuyStrat`** (Trailing Buy Variant)

- **目的**:
    
    - 增加了一个动态买入逻辑，即当市场价格回调到一定程度时触发买入（Trailing Buy）。
- **主要逻辑变化**：
    
    - 增加了动态买入机制：
        - **`trailing_buy_order_enabled`**：启用尾随买入。
        - **`trailing_buy_offset`**：设置为 0.005，表示价格必须比初始触发价格回调至少 0.5% 才会买入。
    - 自定义信息存储（`custom_info`）：
        - 用于记录和管理每个交易对的尾随买入状态，包括以下信息：
            - 是否开启尾随买入（`trailing_buy_order_started`）。
            - 当前的尾随买入价格上限（`trailing_buy_order_uplimit`）。
            - 开始尾随时的价格（`start_trailing_price`）。
- **买入逻辑变化**：
    
    - 如果满足买入信号（`pre_buy`），尾随买入机制启动，记录初始价格和上限。
    - 当价格低于 `start_trailing_price` 且满足尾随回调条件时，触发买入。
- **卖出逻辑**：
    
    - 保持父类的卖出逻辑，但在卖出后会重置尾随买入状态。

* * *

### 总结

- **`NASOSv5HO`**：针对超参数优化的版本，调整了买卖参数以适应不同市场条件。
- **`NASOSv5PD`**：增加了泵涨检测逻辑，防止在市场剧烈波动时买入。
- **`NASOSv5SL`**：增加了动态止损逻辑，更灵活地管理止损点。
- **`TrailingBuyStrat`**：增加了尾随买入机制，允许在价格回调时抓住买入机会。

每个子类都在父类的基础上针对特定场景进行了优化和扩展，可以根据具体的市场环境选择合适的策略。
